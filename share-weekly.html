<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Weekly Progress - 100 Days of Workout</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .status {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #e74c3c;
            margin: 20px 0;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #25D366;
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            margin: 10px 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(37, 211, 102, 0.4);
        }
        .btn-secondary {
            background: #667eea;
        }
        .btn-secondary:hover {
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-state">
            <div class="icon">üìä</div>
            <h1>Weekly Progress</h1>
            <p class="status">Loading data from cloud...</p>
            <div class="loader"></div>
        </div>

        <div id="ready-state" class="hidden">
            <div class="icon">üöÄ</div>
            <h1>Ready to Share!</h1>
            <p class="status">Your weekly summary is ready</p>
            <div class="preview" id="summary-preview"></div>
            <a href="#" id="whatsapp-btn" class="btn">üì§ Share on WhatsApp</a>
            <br>
            <a href="#" id="copy-btn" class="btn btn-secondary">üìã Copy to Clipboard</a>
            <br><br>
            <a href="/" class="btn btn-secondary">üè† Go to App</a>
        </div>

        <div id="error-state" class="hidden">
            <div class="icon">üòï</div>
            <h1>Oops!</h1>
            <p class="error" id="error-message">Could not load data</p>
            <a href="/" class="btn btn-secondary">üè† Go to App</a>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbz7oWHMpsI_jHb7kjsjtCJGclLXlANndjDdYAzeE0PUcbp7yLenJDSfCMWoMiDehe9O/exec',
            STORAGE_KEY: 'workout100_data_v5'
        };

        // Challenge settings
        let challengeSettings = {
            startDate: '2026-02-01',
            endDate: '2026-07-31',
            totalDays: 100,
            seasonName: 'Season 6'
        };

        let participants = [];
        let summaryText = '';

        // Utility functions
        function formatShortDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${date.getDate()} ${months[date.getMonth()]}`;
        }

        function getCurrentDay() {
            const start = new Date(challengeSettings.startDate);
            const end = new Date(challengeSettings.endDate);
            const today = new Date();
            start.setHours(0, 0, 0, 0);
            end.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const totalPeriodDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const diff = Math.floor((today - start) / (1000 * 60 * 60 * 24)) + 1;
            return Math.max(1, Math.min(diff, totalPeriodDays));
        }

        function getWeekStart() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function getDateString(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getDateInTimezone(timezone) {
            const now = new Date();
            const options = { timeZone: timezone, year: 'numeric', month: '2-digit', day: '2-digit' };
            const dateStr = now.toLocaleDateString('en-CA', options);
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function getWeekStartForParticipant(participant) {
            const timezone = participant?.timezone || 'Asia/Kolkata';
            const today = getDateInTimezone(timezone);
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(diff);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function calculateTotalWorkouts(user) {
            if (!user.checkins) return 0;
            return Object.values(user.checkins).filter(v => v === 'Y').length;
        }

        function calculateWeeklyWorkouts(user) {
            if (!user.checkins) return 0;
            const weekStart = getWeekStartForParticipant(user);
            let count = 0;
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const dateStr = getDateString(date);
                if (user.checkins[dateStr] === 'Y') count++;
            }
            return count;
        }

        function calculateStreak(user) {
            if (!user.checkins) return 0;
            const timezone = user?.timezone || 'Asia/Kolkata';
            const today = getDateInTimezone(timezone);
            let streak = 0;
            let currentDate = new Date(today);
            let checkingToday = true;

            while (true) {
                const dateStr = getDateString(currentDate);
                const status = user.checkins[dateStr];

                if (status === 'Y') {
                    streak++;
                    checkingToday = false;
                } else if (status === 'R') {
                    // Rest day - continue checking
                } else if (checkingToday && !status) {
                    // Today not logged yet, check yesterday
                } else {
                    break;
                }

                currentDate.setDate(currentDate.getDate() - 1);
                checkingToday = false;

                if (currentDate < new Date(challengeSettings.startDate)) break;
            }

            return streak;
        }

        // Get week end date (Sunday)
        function getWeekEnd() {
            const weekStart = getWeekStart();
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            return weekEnd;
        }

        // Generate weekly summary - compact format with tied rankings
        function generateWeeklySummary() {
            // Calculate stats for each participant
            participants.forEach(p => {
                p.totalWorkouts = calculateTotalWorkouts(p);
                p.weeklyWorkouts = calculateWeeklyWorkouts(p);
                p.streak = calculateStreak(p);
            });

            const weekStart = getWeekStart();
            const weekEnd = getWeekEnd();
            const currentDay = getCurrentDay();

            // Group participants by weekly workout count
            const groupedByCount = {};
            participants.forEach(p => {
                const count = p.weeklyWorkouts;
                if (!groupedByCount[count]) groupedByCount[count] = [];
                groupedByCount[count].push(p.name);
            });

            // Sort counts descending (7, 6, 5, 4, 3, 2, 1, 0)
            const sortedCounts = Object.keys(groupedByCount)
                .map(Number)
                .sort((a, b) => b - a);

            // Calculate total workouts and active participants
            const totalWeekWorkouts = participants.reduce((sum, p) => sum + p.weeklyWorkouts, 0);
            const activeCount = participants.filter(p => p.weeklyWorkouts > 0).length;

            // Find streak leader
            const streakLeader = [...participants].sort((a, b) => b.streak - a.streak)[0];

            // Build the message
            let text = `*üìä 100 Days of Workout - Weekly Update*\n`;
            text += `üìÖ ${formatShortDate(weekStart)} - ${formatShortDate(weekEnd)} | Day ${currentDay}/100\n`;
            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            text += `üí™ ${totalWeekWorkouts} workouts this week | ${activeCount} active\n\n`;

            text += `*üèÜ This Week's Rankings:*\n`;

            // Generate rankings with tied ranks
            let rank = 1;
            sortedCounts.forEach((count, index) => {
                if (count === 0) return; // Skip people with 0 workouts

                const names = groupedByCount[count];
                const displayRank = rank;

                // For top 4 ranks or if 3 or fewer people, show names
                // Otherwise show "+N others"
                if (displayRank <= 4 || names.length <= 3) {
                    if (names.length <= 4) {
                        text += `#${displayRank} (${count}) ${names.join(', ')}\n`;
                    } else {
                        // Show first 3 names + others
                        text += `#${displayRank} (${count}) ${names.slice(0, 3).join(', ')} +${names.length - 3} more\n`;
                    }
                } else {
                    text += `#${displayRank} (${count}) +${names.length} others\n`;
                }

                rank++; // Dense ranking - each unique score gets next rank
            });

            // Show who didn't workout (0 count) if any
            if (groupedByCount[0] && groupedByCount[0].length > 0) {
                const zeroCount = groupedByCount[0].length;
                text += `‚è∏Ô∏è (0) ${zeroCount} resting\n`;
            }

            // Streak leader highlight
            if (streakLeader && streakLeader.streak > 0) {
                text += `\nüî• *Longest Streak:* ${streakLeader.name} (${streakLeader.streak} days)\n`;
            }

            text += `\n#100DaysOfWorkout`;

            return text;
        }

        // Load data from cloud
        async function loadData() {
            // First try local storage (most reliable if user has logged in before)
            const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (data.participants && data.participants.length > 0) {
                        participants = data.participants;
                        if (data.challengeSettings) {
                            challengeSettings = { ...challengeSettings, ...data.challengeSettings };
                        }

                        // Try to refresh from cloud using stored user's phone
                        if (data.currentUser && data.currentUser.phone) {
                            try {
                                const response = await fetch(CONFIG.API_URL, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'text/plain' },
                                    body: JSON.stringify({ action: 'login', phone: data.currentUser.phone })
                                });
                                const result = await response.json();
                                if (result.success && result.data && result.data.participants) {
                                    participants = result.data.participants;
                                    console.log('Refreshed data from cloud');
                                }
                            } catch (e) {
                                console.log('Cloud refresh failed, using local data');
                            }
                        }
                        return true;
                    }
                } catch (e) {
                    console.log('Error parsing local storage:', e);
                }
            }

            return false;
        }

        // Show states
        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('ready-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function showReady() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('ready-state').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('ready-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        // Initialize
        async function init() {
            showLoading();

            const loaded = await loadData();

            if (!loaded || participants.length === 0) {
                showError('No data found. Please log into the main app first on this device, then come back here.');
                return;
            }

            // Generate summary
            summaryText = generateWeeklySummary();

            // Show preview
            document.getElementById('summary-preview').textContent = summaryText;

            // Set up WhatsApp button
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(summaryText)}`;
            document.getElementById('whatsapp-btn').href = whatsappUrl;

            // Set up copy button
            document.getElementById('copy-btn').addEventListener('click', (e) => {
                e.preventDefault();
                navigator.clipboard.writeText(summaryText).then(() => {
                    alert('Copied to clipboard!');
                });
            });

            showReady();

            // Check if auto-open is requested via URL param
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('auto') === 'true') {
                // Small delay to let user see what's happening
                setTimeout(() => {
                    window.location.href = whatsappUrl;
                }, 1500);
            }
        }

        // Start
        init();
    </script>
</body>
</html>
